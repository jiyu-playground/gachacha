<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê°€ì± ìƒµ ë°ì´í„° ìˆ˜ì§‘ê¸°</title>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=JSí‚¤ ë“±ë¡ í•„ìˆ˜&libraries=services"></script>
  </head>
  <body>
    <div style="padding: 20px; font-family: Arial">
      <h1>ğŸ¯ ê°€ì± ìƒµ ë°ì´í„° ìˆ˜ì§‘ê¸°</h1>
      <p>ì „êµ­ ê°€ì± ìƒµ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•´ì„œ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>

      <button
        onclick="startDataCollection()"
        style="
          padding: 15px 30px;
          font-size: 16px;
          background: #3498db;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        "
      >
        ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘!
      </button>

      <div id="status" style="margin-top: 20px; font-weight: bold"></div>
      <div
        id="log"
        style="
          margin-top: 10px;
          background: #f4f4f4;
          padding: 10px;
          height: 300px;
          overflow-y: scroll;
          font-family: monospace;
          font-size: 12px;
        "
      ></div>
    </div>

    <script>
      class SimpleGachaCollector {
        constructor(apiKey) {
          this.apiKey = apiKey;
          this.allShops = []; // ìˆ˜ì§‘ëœ ëª¨ë“  ê°€ì± ìƒµ ë°ì´í„°
        }

        // ì „êµ­ ì£¼ìš” ë„ì‹œì—ì„œ ê°€ì± ìƒµ ë°ì´í„° ìˆ˜ì§‘
        async collectAllData() {
          // ì „êµ­ ì£¼ìš” ë„ì‹œë“¤ (ë” ë§ì´ ì¶”ê°€í•´ì„œ ì „êµ­ì ìœ¼ë¡œ ìˆ˜ì§‘)
          const cities = [
            { name: "ì„œìš¸", lat: 37.5665, lng: 126.978 },
            { name: "ë¶€ì‚°", lat: 35.1796, lng: 129.0756 },
            { name: "ëŒ€êµ¬", lat: 35.8714, lng: 128.601 },
            { name: "ì¸ì²œ", lat: 37.4563, lng: 126.7052 },
            { name: "ê´‘ì£¼", lat: 35.1595, lng: 126.8526 },
            { name: "ëŒ€ì „", lat: 36.3504, lng: 127.3845 },
            { name: "ìš¸ì‚°", lat: 35.5384, lng: 129.3114 },
            { name: "ìˆ˜ì›", lat: 37.2636, lng: 127.0286 },
            { name: "ê³ ì–‘", lat: 37.6564, lng: 126.8358 },
            { name: "ì„±ë‚¨", lat: 37.4201, lng: 127.1262 },
            { name: "ì²­ì£¼", lat: 36.6424, lng: 127.489 },
            { name: "ì „ì£¼", lat: 35.8242, lng: 127.148 },
            { name: "ì•ˆì‚°", lat: 37.3219, lng: 126.8309 },
            { name: "ì²œì•ˆ", lat: 36.8151, lng: 127.1139 },
            { name: "í¬í•­", lat: 36.019, lng: 129.3435 },
          ];

          console.log("ğŸ¯ ì „êµ­ ê°€ì± ìƒµ ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œì‘í•©ë‹ˆë‹¤!");
          console.log(`ğŸ“ ì´ ${cities.length}ê°œ ë„ì‹œì—ì„œ ê²€ìƒ‰í•  ì˜ˆì •ì…ë‹ˆë‹¤.`);

          // ê° ë„ì‹œë³„ë¡œ ê²€ìƒ‰
          for (let i = 0; i < cities.length; i++) {
            const city = cities[i];
            console.log(
              `\nğŸ” [${i + 1}/${cities.length}] ${city.name} ì§€ì—­ ê²€ìƒ‰ ì¤‘...`
            );

            await this.searchInCity(city);

            // API í˜¸ì¶œ ì œí•œì„ ìœ„í•´ ë„ì‹œë§ˆë‹¤ 3ì´ˆ ëŒ€ê¸°
            if (i < cities.length - 1) {
              console.log("â³ 3ì´ˆ ëŒ€ê¸° ì¤‘... (API ì œí•œ ë•Œë¬¸ì—)");
              await this.wait(3000);
            }
          }

          // ì¤‘ë³µ ì œê±°
          this.removeDuplicateShops();

          // JSON íŒŒì¼ë¡œ ì €ì¥
          this.downloadJSON();

          console.log(
            `\nğŸ‰ ìˆ˜ì§‘ ì™„ë£Œ! ì´ ${this.allShops.length}ê°œì˜ ê°€ì± ìƒµì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!`
          );
        }

        // íŠ¹ì • ë„ì‹œì—ì„œ ê°€ì± ìƒµ ê²€ìƒ‰
        async searchInCity(city) {
          return new Promise((resolve) => {
            const ps = new window.kakao.maps.services.Places();
            const searchKeywords = ["ê°€ì± ", "ê°€ì°¨", "ìº¡ìŠí† ì´"]; // ê²€ìƒ‰í•  í‚¤ì›Œë“œë“¤
            let finishedSearches = 0;

            // ê° í‚¤ì›Œë“œë³„ë¡œ ê²€ìƒ‰
            searchKeywords.forEach((keyword, index) => {
              setTimeout(() => {
                ps.keywordSearch(
                  keyword,
                  (results, status) => {
                    if (status === window.kakao.maps.services.Status.OK) {
                      console.log(
                        `  âœ… "${keyword}" ê²€ìƒ‰: ${results.length}ê°œ ë°œê²¬`
                      );

                      // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥ (í•„í„°ë§ ì—†ì´)
                      results.forEach((place) => {
                        this.allShops.push({
                          id: place.id,
                          place_name: place.place_name,
                          x: place.x, // ê²½ë„
                          y: place.y, // ìœ„ë„
                          road_address_name: place.road_address_name,
                          address_name: place.address_name,
                          phone: place.phone,
                          category_name: place.category_name,
                          place_url: place.place_url,
                          search_keyword: keyword, // ì–´ë–¤ í‚¤ì›Œë“œë¡œ ì°¾ì•˜ëŠ”ì§€ ê¸°ë¡
                          search_city: city.name, // ì–´ëŠ ë„ì‹œì—ì„œ ì°¾ì•˜ëŠ”ì§€ ê¸°ë¡
                          collected_at: new Date().toISOString(), // ì–¸ì œ ìˆ˜ì§‘í–ˆëŠ”ì§€ ê¸°ë¡
                        });
                      });
                    } else {
                      console.log(`  âŒ "${keyword}" ê²€ìƒ‰ ì‹¤íŒ¨ ë˜ëŠ” ê²°ê³¼ ì—†ìŒ`);
                    }

                    finishedSearches++;
                    if (finishedSearches === searchKeywords.length) {
                      resolve(); // ì´ ë„ì‹œì˜ ëª¨ë“  í‚¤ì›Œë“œ ê²€ìƒ‰ ì™„ë£Œ
                    }
                  },
                  {
                    location: new window.kakao.maps.LatLng(city.lat, city.lng),
                    radius: 20000, // 30km ë°˜ê²½ì—ì„œ ê²€ìƒ‰
                    size: 15, // í‚¤ì›Œë“œë‹¹ ìµœëŒ€ 15ê°œ
                  }
                );
              }, index * 1500); // í‚¤ì›Œë“œë§ˆë‹¤ 1.5ì´ˆ ê°„ê²©
            });
          });
        }

        // ì¤‘ë³µëœ ê°€ê²Œ ì œê±° (ê°™ì€ ì´ë¦„, ê°™ì€ ì¢Œí‘œ)
        removeDuplicateShops() {
          console.log("\nğŸ§¹ ì¤‘ë³µ ê°€ê²Œ ì œê±° ì¤‘...");
          const beforeCount = this.allShops.length;

          const uniqueShops = new Map();

          this.allShops.forEach((shop) => {
            // ê°€ê²Œ ì´ë¦„ + ì¢Œí‘œë¡œ ê³ ìœ  í‚¤ ìƒì„±
            const uniqueKey = `${shop.place_name.trim()}-${shop.x}-${shop.y}`;

            if (!uniqueShops.has(uniqueKey)) {
              uniqueShops.set(uniqueKey, shop);
            }
          });

          this.allShops = Array.from(uniqueShops.values());
          const afterCount = this.allShops.length;

          console.log(
            `ğŸ“Š ì¤‘ë³µ ì œê±° ê²°ê³¼: ${beforeCount}ê°œ â†’ ${afterCount}ê°œ (${
              beforeCount - afterCount
            }ê°œ ì¤‘ë³µ ì œê±°)`
          );
        }

        // JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        downloadJSON() {
          const jsonData = {
            collection_info: {
              collected_at: new Date().toISOString(),
              total_shops: this.allShops.length,
              collection_method: "ì¹´ì¹´ì˜¤ë§µ í‚¤ì›Œë“œ ê²€ìƒ‰",
              keywords_used: ["ê°€ì± ", "ê°€ì°¨", "ìº¡ìŠí† ì´", "ê°€ì± í°"],
              note: "ì „êµ­ ì£¼ìš” ë„ì‹œ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì§‘ëœ ë°ì´í„°ì…ë‹ˆë‹¤.",
            },
            shops: this.allShops,
          };

          // JSON ë¬¸ìì—´ë¡œ ë³€í™˜
          const jsonString = JSON.stringify(jsonData, null, 2);

          // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          const downloadLink = document.createElement("a");
          downloadLink.href = url;
          downloadLink.download = `gacha-shops-database-${
            new Date().toISOString().split("T")[0]
          }.json`;
          downloadLink.click();

          URL.revokeObjectURL(url);

          console.log("ğŸ’¾ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!");
          console.log("ğŸ“ íŒŒì¼ëª…:", downloadLink.download);
        }

        // ëŒ€ê¸° í•¨ìˆ˜
        wait(milliseconds) {
          return new Promise((resolve) => setTimeout(resolve, milliseconds));
        }
      }

      async function startDataCollection() {
        const statusDiv = document.getElementById("status");
        const logDiv = document.getElementById("log");

        statusDiv.textContent =
          "ğŸ” ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (ëª‡ ë¶„ ì •ë„ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”)";
        logDiv.innerHTML = "";

        // ì½˜ì†” ë¡œê·¸ë¥¼ í™”ë©´ì—ë„ í‘œì‹œ
        const originalLog = console.log;
        console.log = function (...args) {
          originalLog.apply(console, args);
          logDiv.innerHTML += args.join(" ") + "<br>";
          logDiv.scrollTop = logDiv.scrollHeight;
        };

        try {
          const collector = new SimpleGachaCollector();
          await collector.collectAllData();

          statusDiv.textContent =
            "âœ… ìˆ˜ì§‘ ì™„ë£Œ! JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.";
          statusDiv.style.color = "green";
        } catch (error) {
          statusDiv.textContent = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + error.message;
          statusDiv.style.color = "red";
          console.log("ì˜¤ë¥˜:", error);
        }

        // ì›ë˜ console.logë¡œ ë³µì›
        console.log = originalLog;
      }
    </script>
  </body>
</html>
